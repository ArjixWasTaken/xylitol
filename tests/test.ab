import * from "assert.ab"
import * from "../src/utils.ab"
import * from "../src/utils/perl.ab"

fun test_ansi_escape(): Null {
    let case = "Hello, World!"
    assert(not has_ansi_escape(case), "Case 1 should not have ANSI escape sequences")

    let case = "ì•ˆë…•, ì„¸ìƒ!"
    assert(not has_ansi_escape(case), "Case 2 should not have ANSI escape sequences")

    let case = "\x1b[31mRed Text\x1b[0m"
    assert(has_ansi_escape(case), "Case 3 should have ANSI escape sequences")

    let case = "Normal \x1b[32mGreen\x1b[0m Text"
    assert(has_ansi_escape(case), "Case 4 should have ANSI escape sequences")

    let case = "\x1b[1;34mBold Blue\x1b[0m"
    assert(has_ansi_escape(case), "Case 5 should have ANSI escape sequences")
}

fun test_cutoff_text(): Null {
    let case = "Hello, World!"
    assert_eq(cutoff_text(case, 5), "He...", "Cutoff Case 1 failed")

    let case = "Short"
    assert_eq(cutoff_text(case, 10), "Short", "Cutoff Case 2 failed")

    let case = "ì•ˆë…•í•˜ì„¸ìš”"
    assert_eq(cutoff_text(case, 7), "ì•ˆë…•...", "Cutoff Case 3 failed")
}

fun test_perl_get_cjk_width(): Null {
    let case = "Hello"
    assert_eq(trust perl_get_cjk_width(case) as Text, 5 as Text, "CJK Case 1 failed")

    let case = "ê³„ì ˆì´ ì§€ë‚˜ê°€ëŠ” í•˜ëŠ˜ì—ëŠ” ê°€ì„ë¡œ ê°€ë“ ì°¨ ìˆìŠµë‹ˆë‹¤."
    assert_eq(trust perl_get_cjk_width(case) as Text, 49 as Text, "CJK Case 2 failed")

    let case = "å¤æ± ã‚„ è›™é£›ã³è¾¼ã‚€ æ°´ã®éŸ³"
    assert_eq(trust perl_get_cjk_width(case) as Text, 24 as Text, "CJK Case 3 failed")

    let case = "å­¸è€Œæ™‚ç¿’ä¹‹ ä¸äº¦èªªä¹"
    assert_eq(trust perl_get_cjk_width(case) as Text, 19 as Text, "CJK Case 4 failed")

    let case = "ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ğŸ˜†ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‡"
    assert_eq(trust perl_get_cjk_width(case) as Text, 20 as Text, "CJK Case 5 failed")

    let case = "ğŸŒ¸ Select Language"
    assert_eq(trust perl_get_cjk_width(case) as Text, 18 as Text, "CJK Case 6 failed")
}

fun test_perl_truncate_cjk(): Null {
    let case = "ì•ˆë…•í•˜ì„¸ìš” Hello"
    assert_eq(trust perl_truncate_cjk(case, 10), "ì•ˆë…•í•˜ì„¸ìš”", "Truncate CJK Case 1 failed")

    let case = "Hello World"
    assert_eq(trust perl_truncate_cjk(case, 5), "Hello", "Truncate CJK Case 2 failed")

    let case = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬"
    assert_eq(trust perl_truncate_cjk(case, 8), "ê°€ë‚˜ë‹¤ë¼", "Truncate CJK Case 3 failed")

    let case = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬"
    assert_eq(trust perl_truncate_cjk(case, 7), "ê°€ë‚˜ë‹¤", "Truncate CJK Case 4 failed")

    let case = "Mixæ··åˆãƒ†ã‚¹ãƒˆ"
    assert_eq(trust perl_truncate_cjk(case, 7), "Mixæ··åˆ", "Truncate CJK Case 5 failed")
}

fun test_perl_substr_cjk(): Null {
    let case = "ì•ˆë…•í•˜ì„¸ìš” Hello"
    assert_eq(trust perl_substr_cjk(case, 4, 12), "í•˜ì„¸ìš” H", "Substr CJK Case 1 failed")

    let case = "Hello World"
    assert_eq(trust perl_substr_cjk(case, 0, 5), "Hello", "Substr CJK Case 2 failed")

    let case = "ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬"
    assert_eq(trust perl_substr_cjk(case, 2, 10), "ë‚˜ë‹¤ë¼ë§ˆ", "Substr CJK Case 3 failed")

    let case = "Mixæ··åˆãƒ†ã‚¹ãƒˆ"
    assert_eq(trust perl_substr_cjk(case, 3, 9), "æ··åˆãƒ†", "Substr CJK Case 4 failed")
}

fun test_strip_ansi(): Null {
    // Simple ANSI colored text
    let case = "\x1b[31mRed Text\x1b[0m"
    assert_eq(strip_ansi(case), "Red Text", "Strip ANSI Case 1 failed")

    // Multiple ANSI sequences
    let case = "\x1b[1mBold\x1b[0m and \x1b[31mRed\x1b[0m"
    assert_eq(strip_ansi(case), "Bold and Red", "Strip ANSI Case 2 failed")

    // Plain text (no ANSI)
    let case = "Hello World"
    assert_eq(strip_ansi(case), "Hello World", "Strip ANSI Case 3 failed")

    // Truecolor ANSI sequence (38;2;r;g;b)
    let case = "\x1b[38;2;3;207;159mTruecolor Text\x1b[0m"
    assert_eq(strip_ansi(case), "Truecolor Text", "Strip ANSI Case 4 failed")

    // Background truecolor (48;2;r;g;b)
    let case = "\x1b[48;2;255;100;50mBackground\x1b[0m"
    assert_eq(strip_ansi(case), "Background", "Strip ANSI Case 5 failed")

    // Combined foreground and background truecolor
    let case = "\x1b[38;2;255;255;255;48;2;0;0;0mWhite on Black\x1b[0m"
    assert_eq(strip_ansi(case), "White on Black", "Strip ANSI Case 6 failed")

    // 256 color mode (38;5;n)
    let case = "\x1b[38;5;196mRed 256\x1b[0m"
    assert_eq(strip_ansi(case), "Red 256", "Strip ANSI Case 7 failed")

    // CJK with ANSI
    let case = "\x1b[1mì•ˆë…•í•˜ì„¸ìš”\x1b[0m"
    assert_eq(strip_ansi(case), "ì•ˆë…•í•˜ì„¸ìš”", "Strip ANSI Case 8 failed")
}

fun test_truncate_ansi(): Null {
    // Simple ANSI colored text
    let case = "\x1b[31mRed Text\x1b[0m"
    assert_eq(truncate_ansi(case, 5), "\x1b[31mRed T\x1b[0m", "Truncate ANSI Case 1 failed")

    // Text with 'm' in content
    let case = "\x1b[32mSome message here\x1b[0m"
    assert_eq(truncate_ansi(case, 10), "\x1b[32mSome messa\x1b[0m", "Truncate ANSI Case 2 failed")

    // Multiple ANSI sequences
    let case = "\x1b[1mBold\x1b[0m and \x1b[31mRed\x1b[0m"
    assert_eq(truncate_ansi(case, 8), "\x1b[1mBold\x1b[0m and\x1b[31m\x1b[0m", "Truncate ANSI Case 3 failed")

    // No truncation needed
    let case = "\x1b[34mShort\x1b[0m"
    assert_eq(truncate_ansi(case, 10), "\x1b[34mShort\x1b[0m", "Truncate ANSI Case 4 failed")

    // Plain text (no ANSI)
    let case = "Hello World"
    assert_eq(truncate_ansi(case, 8), "Hello Wo", "Truncate ANSI Case 5 failed")

    // Truecolor ANSI sequence
    let case = "\x1b[38;2;3;207;159mTruecolor Text\x1b[0m"
    assert_eq(truncate_ansi(case, 10), "\x1b[38;2;3;207;159mTruecolor \x1b[0m", "Truncate ANSI Case 6 failed")

    // CJK characters with ANSI
    let case = "\x1b[1mì•ˆë…•í•˜ì„¸ìš”\x1b[0m"
    assert_eq(truncate_ansi(case, 6), "\x1b[1mì•ˆë…•í•˜\x1b[0m", "Truncate ANSI Case 7 failed")

    // CJK characters with ANSI 2
    let case = "\x1b[1mì•ˆë…•í•˜ì„¸ìš”\x1b[0m"
    assert_eq(truncate_ansi(case, 9), "\x1b[1mì•ˆë…•í•˜ì„¸\x1b[0m", "Truncate ANSI Case 8 failed")
}

main {
    test_ansi_escape()
    test_perl_get_cjk_width()
    test_cutoff_text()
    test_perl_truncate_cjk()
    test_perl_substr_cjk()
    test_strip_ansi()
    test_truncate_ansi()
    eprintf_colored("All tests passed!\n", 92)
}
